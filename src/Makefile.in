# makefile for the CGNS Library
#
# executing as:
#    make
# will build the CGNS library for the system
# defined in make.system
#
# executing as:
#     make SYSTEM=system_name
# will build for system "system_name"

include make.system
include make.$(SYSTEM)

CGNSVER = @CGNSVERS@

.SUFFIXES :
.SUFFIXES : .c .$(O) $(EXE)

OBJDIR  = $(SYSTEM)
COPTS	= $(CFLAGS) $(CFGFLAGS) -I. @BUILDOPTS@
CGNSLIB = $(LIBCGNS)
INSTLIB = libcgns.$(A)

#----------

CGNSOBJS=\
	$(OBJDIR)/cgns_error.$(O) \
	$(OBJDIR)/cgns_internals.$(O) \
	$(OBJDIR)/cgns_io.$(O) \
	$(OBJDIR)/cgnslib.$(O)

# ADF/ADFH routines

ADFOBJS=@ADFOBJS@ \
	$(OBJDIR)/ADF_interface.$(O) \
	$(OBJDIR)/ADF_internals.$(O)

# Fortran interface routines
# comment this out if you don't want/need Fortran

@F2COBJS@=$(OBJDIR)/cg_ftoc.$(O) $(OBJDIR)/cgio_ftoc.$(O)

#----------

lib : $(CGNSLIB)
all : lib tools tests cgnstools

$(CGNSLIB) : $(OBJDIR) $(CGNSOBJS) $(ADFOBJS) $(F2COBJS)
	-@$(RM) $@
	$(AR) $(AROUT)$@ $(CGNSOBJS) $(ADFOBJS) $(F2COBJS)
	$(RANLIB) $@

$(OBJDIR) :
	-$(MKDIR) $(OBJDIR)

#----------

tools : $(CGNSLIB)
	-cd tools && $(MAKE)

tests : $(CGNSLIB)
	-cd tests && $(MAKE)

cgnstools : $(CGNSLIB)
	-cd cgnstools && $(MAKE)

#----------

clean :
	-$(RM) $(OBJDIR)/*.$(O)
	-cd tests && $(MAKE) clean
	-cd tools && $(MAKE) clean
	@if [ -f cgnstools/Makefile ] ; then \
	   cd cgnstools && $(MAKE) clean; \
	 fi;

allclean : distclean

distclean :
	-cd tests && $(MAKE) allclean
	-$(RM) tests/Makefile
	-cd tools && $(MAKE) allclean
	-$(RM) tools/Makefile
	@if [ -f cgnstools/Makefile ] ; then \
	   cd cgnstools && $(MAKE) distclean; \
	 fi;
	-$(RM) $(CGNSLIB)
	-$(RM) $(OBJDIR)/*.$(O)
	-$(RMDIR) $(OBJDIR)
	-$(RM) cgnstypes.h cgnstypes_f.h cgnslib_f.h
	-$(RM) make.system make.defs make.$(SYSTEM)
	-$(RM) config.log config.status Makefile

install : $(CGNSLIB) $(INCLUDEDIR) $(LIBDIR)
	$(INSTALL_DATA) cgnstypes.h $(INCLUDEDIR)/cgnstypes.h
	$(INSTALL_DATA) cgnstypes_f.h $(INCLUDEDIR)/cgnstypes_f.h
	$(INSTALL_DATA) cgnslib.h $(INCLUDEDIR)/cgnslib.h
	$(INSTALL_DATA) cgnslib_f.h $(INCLUDEDIR)/cgnslib_f.h
	$(INSTALL_DATA) cgnswin_f.h $(INCLUDEDIR)/cgnswin_f.h
	$(INSTALL_DATA) cgns_io.h $(INCLUDEDIR)/cgns_io.h
	$(INSTALL_DATA) $(CGNSLIB) $(LIBDIR)/$(INSTLIB)

$(INCLUDEDIR) :
	@if [ ! -d $(INCLUDEDIR) ] ; then \
	    echo "Making directory $(INCLUDEDIR)"; \
	    mkdir -p $(INCLUDEDIR); \
	    chmod 755 $(INCLUDEDIR); \
	  fi;

$(LIBDIR) :
	@if [ ! -d $(LIBDIR) ] ; then \
	    echo "Making directory $(LIBDIR)"; \
	    mkdir -p $(LIBDIR); \
	    chmod 755 $(LIBDIR); \
	  fi;

uninstall :
	-$(RM) $(INCLUDEDIR)/cgnstypes.h
	-$(RM) $(INCLUDEDIR)/cgnstypes_f.h
	-$(RM) $(INCLUDEDIR)/cgnslib.h
	-$(RM) $(INCLUDEDIR)/cgnslib_f.h
	-$(RM) $(INCLUDEDIR)/cgnswin_f.h
	-$(RM) $(INCLUDEDIR)/cgns_io.h
	-$(RM) $(LIBDIR)/$(INSTLIB)

#---------- mid-level library

$(OBJDIR)/cgns_error.$(O) : cgns_error.c cgnslib.h cgns_header.h cgns_io.h
	$(CC) $(COPTS) $(COOUT)$@ -c cgns_error.c

$(OBJDIR)/cgns_internals.$(O) : cgns_internals.c cgnslib.h cgns_header.h \
	cgns_io.h
	$(CC) $(COPTS) $(COOUT)$@ -c cgns_internals.c

$(OBJDIR)/cgnslib.$(O) : cgnslib.c cgnslib.h cgns_header.h cgns_io.h
	$(CC) $(COPTS) $(COOUT)$@ -c cgnslib.c

$(OBJDIR)/cgns_io.$(O) : cgns_io.c cgnslib.h cgns_io.h \
	adf/ADF.h @ADFINCS@
	$(CC) $(COPTS) $(COOUT)$@ -c cgns_io.c

$(OBJDIR)/cg_ftoc.$(O) : cg_ftoc.c fortran_macros.h cgnslib.h \
	cgns_header.h cgns_io.h
	$(CC) $(COPTS) $(F2CFLAGS) $(COOUT)$@ -c cg_ftoc.c

$(OBJDIR)/cgio_ftoc.$(O) : cgio_ftoc.c fortran_macros.h cgns_io.h
	$(CC) $(COPTS) $(F2CFLAGS) $(COOUT)$@ -c cgio_ftoc.c

$(OBJDIR)/cg_malloc.$(O) : cg_malloc.c cg_malloc.h
	$(CC) $(COPTS) $(COOUT)$@ -c cg_malloc.c

cgnslib.h : cgnstypes.h
cgns_header.h : cgnstypes.h
cgns_io.h : cgnstypes.h

#---------- ADF

$(OBJDIR)/ADF_interface.$(O) : adf/ADF_interface.c \
	adf/ADF.h adf/ADF_internals.h
	$(CC) $(COPTS) -Iadf $(COOUT)$@ -c adf/ADF_interface.c

$(OBJDIR)/ADF_internals.$(O) : adf/ADF_internals.c \
	adf/ADF.h adf/ADF_internals.h
	$(CC) $(COPTS) -Iadf $(COOUT)$@ -c adf/ADF_internals.c

adf/ADF.h : cgnstypes.h
adf/ADF_internals.h : cgnstypes.h

#---------- HDF5

$(OBJDIR)/ADFH.$(O) : adfh/ADFH.c adfh/ADFH.h
	$(CC) $(COPTS) -Iadfh $(HDF5INC) $(COOUT)$@ -c adfh/ADFH.c

adfh/ADFH.h : cgnstypes.h

